#!/usr/bin/env ruby

CONF_DIR = File.expand_path('~/.ssh/config.d')
SSH_CONFIG = File.expand_path('~/.ssh/config')
MAGIC_LINE = "# Generated by #{File.basename(__FILE__)}"

if !File.directory?(CONF_DIR)
  puts "#{CONF_DIR} does not exist or is not a directory"
  Process.exit!(1)
end

if File.exists?(SSH_CONFIG) && File.new(SSH_CONFIG).gets == "#{MAGIC_LINE}\n"
  puts "Found generated ssh_config under $SSH_CONFIG. Overwriting..."
elsif File.exists?(SSH_CONFIG)
  puts "Found hand-crafted ssh_config under $SSH_CONFIG. Please move it out of the way."
  Process.exit!(2)
end

File.open(SSH_CONFIG, 'w') do |ssh_config|
  ssh_config.puts(MAGIC_LINE)
  ssh_config.puts("# DO NOT EDIT THIS FILE")
  ssh_config.puts("# Create or modify files under #{CONF_DIR}/ instead")
end

Dir["#{CONF_DIR}/**"].reject{|file| file =~ /\.disabled$/}.sort.each do |file|
  %x(/bin/cat #{file} >> #{SSH_CONFIG})
  %x(echo >> #{SSH_CONFIG})
end
